define(function(e,t,n){"use strict";function Se(e){e.preventDefault(),e.stopImmediatePropagation()}function Le(e,t){I.set(e,t),I.save()}function xe(e){P.open(e);var t=window.setTimeout(function(){P.isOpen()||xe(e),window.clearTimeout(t)},180)}function Fe(e,t,n){p.setFileViewFocus(p.WORKING_SET_VIEW),h.execute(g.FILE_OPEN,{fullPath:e,paneId:t}).always(function(){u.focusActivePane()}).done(n)}function _e(e,t,n,i){var a=u.getCurrentlyViewedFile(t);return!a&&n?void Fe(n.fullPath,t,function(){i&&xe(e)}):void((i||a.id!==n.id)&&(a.id===n.id&&i?xe(e):Fe(n.fullPath,t,function(){i&&xe(e)})))}function De(e,t){h.execute(g.FILE_CLOSE,{file:e,paneId:t}).always(function(){u.focusActivePane()})}function Oe(e,t,n){var i=t===S?L:S,a=u._getPane(i);if(!a.getViewForPath(e.fullPath)){var o=n||u.getActivePaneId(),r=a.findInViewList(e.fullPath);-1!==r&&h.execute(g.FILE_CLOSE,{File:e,paneId:t}),u._moveView(t,i,e).always(function(){h.execute(g.FILE_OPEN,{fullPath:e.fullPath,paneId:i}).always(function(){var e=u._getPane(t),n=o===t?e:a;e.trigger("viewListChange"),a.trigger("viewListChange"),window.setTimeout(function(){n.focus(),e._lastFocusedElement=n.$el[0],u.setActivePaneId(o)},1)})})}}function We(e,t,n,i){u._moveView(t,i,e,n).always(function(){h.execute(g.FILE_OPEN,{fullPath:e.fullPath,paneId:i}).always(function(){u.focusActivePane(),s.refresh(!0)})})}function Ne(e,t,n){u._moveWorkingSetItem(t,e,n),u.focusActivePane()}function He(e,t){var i,n=0;for(i=0;i<e.length;i+=1){if(e[i]===t)return n;1===e[i].nodeType&&(n+=1)}return-1}function Be(){Ee.removeClass("cw-sortable-dragging").addClass("cw-dragged-index"),$e&&$e.length&&($e.is(":visible")||$e.show()),ke&&(ke=!1,ye.remove()),Ie&&(Ie=!1,Te.remove())}function Ae(e,t,n){t!==n?Ne(t,e,n):Be()}function Ve(e,t,n,i,a){if(e!==t){var o=u.findInWorkingSet(t,a.fullPath);o>-1&&(me=!0,e=t,n=o)}var r=0;if(i){var s=i.getElementsByClassName("cw-dragged-index"),c=i.getElementsByClassName("cw-sortable-placeholder")[0];c?r=He(s,c):(r=0,he=!0)}else r=n;if(e!==t)We(a,e,r,t);else{if(me)return me=!1,he?(he=!1,void Be()):void Ae(e,n,r);Ae(e,n,r)}}function Re(e){if(!we){if("dragover"===e.type)return e.originalEvent.dataTransfer.dropEffect="move",!1;if("dragenter"===e.type){if("LI"===e.target.tagName){var t=Me;Me=e.currentTarget.id;var n=$("#"+Me);Ce||(Pe=e.currentTarget,Ce=Pe.attributes["data-paneid"].value);var i=$(e.target);if(i[0]!==ye[0]&&($e=n.find(".cw-dragli-"+ve.id),$e.length&&$e.is(":visible")&&$e.removeClass("cw-dragged-index").hide(),n.find(Te).length||(Te.data(F,0).prependTo(n),Ie=!0),i.after(ye),ke=!0,t&&Me&&t!==Me)){var a=$("#"+t).find(".cw-dragli-"+ve.id);a.is(":visible")||a.addClass("cw-dragged-index").show()}}return e.stopPropagation(),e.preventDefault(),!1}"UL"===e.currentTarget.tagName&&(ge=!1,Pe=e.currentTarget,Ce=Pe.attributes["data-paneid"].value,Ve(be,Ce,pe,Pe,ve))}}function ze(e){var t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&t.right<=(window.innerWidth||document.documentElement.clientWidth)}function je(e,t,n,i){if(t=u.getCurrentlyViewedFile(e)){var a=u.findInWorkingSet(e,t.fullPath);if(!(0>a)&&i[0].scrollWidth>n.width()){var s,o=function(e){if(e=e[0],!ze(e)){var t=e.offsetLeft,a=i[0].scrollWidth-n.width(),o=t>a?a:t;i.data("scrollwheel",o),i.stop().animate({scrollLeft:o},300)}},r=i.find(".cw-dragli-"+t.id);r.length?(clearInterval(s),o(r)):s=setInterval(function(){r=i.find(".cw-dragli-"+t.id),r.length&&(clearInterval(s),o(r))},10)}}}function Ue(e){return de.getElementsByClassName(e)[0]}function Ge(e,t,n){var i=Ue("cw-tooltip-content");return Ue("cw-parentPath").innerHTML=e.parentPath,n?void(i.className="cw-tooltip-content cw-untitled"):(i.className.indexOf("cw-untitled")>-1&&(i.className="cw-tooltip-content"),Ue("cw-id").innerHTML=e.id,Ue("cw-language").innerHTML=m.getLanguageForPath(e.fullPath).getId(),e.stat(function(e,n){e?(Ue("cw-date").innerHTML="...",Ue("cw-size").innerHTML="...",Ue("cw-hash").innerHTML="..."):(Ue("cw-date").innerHTML=n.mtime,Ue("cw-size").innerHTML=(t?"&#177;":"")+r.prettyPrintBytes(n.size.valueOf()),Ue("cw-hash").innerHTML=n._hash)}),void e.read(function(e,t){e?(Ue("cw-chars").innerHTML="...",Ue("cw-lines").innerHTML="...",Ue("cw-le").innerHTML="..."):(Ue("cw-chars").innerHTML=t.length,Ue("cw-lines").innerHTML=r.getLines(t).length,Ue("cw-le").innerHTML=v.sniffLineEndings(t))}))}function Ke(e){$("#cw-arrow").css("left",e.clientX-de.offsetLeft)}function qe(e,t,n,i,a){var f,o=e-t/2,r=i+a,s=window.outerWidth,c=window.outerHeight,l=t>s||0>o?1:o>s-t?s-t-1:o;return n>r||c>r+n?(f=r,de.className="cw-tabbar-tooltip cw-arrow-bottom"):(f=i-n+6,de.className="cw-tabbar-tooltip cw-arrow-top"),{top:f,left:l}}function Xe(e,t,n,i){if(z){var a=d.getOpenDocumentForPath(n.fullPath),o=a?a.isDirty:!1,r=a?a.isUntitled():!1;if(U)G&&(de.style.display="none",K=!1,j=0,G=!1);else if(e=window.event||e,j+=1,j>2&&(K&&Ke(e),!G)){G=!0,Ge(n,o,r),K=!0,de.style.display="block";var s=$("#cw-"+t+"-tabbar"),c=s.outerHeight(),l=s.offset().top,f=de.getBoundingClientRect().width||de.offsetWidth,u=de.getBoundingClientRect().height||de.offsetHeight,w=qe(e.pageX,f,u,l,c),g=qe(e.pageX,de.getBoundingClientRect().width,de.getBoundingClientRect().height,l,c);if(de.style.top=g.top+"px",de.style.left=g.left+"px",i)return w}}}function Je(){if(R&&y.hasClass("cw-force-display")&&!E.hasClass("cw-sidebar")){if(M.isOpen()||P.isOpen()||$("#project-dropdown").is(":visible")||$(".jstree-leaf").find(".jstree-rename-input").length||$(".open-files-container.wsv-drag-ghost").length)return;y.css("z-index",X),y.removeClass("cw-force-display"),E.addClass("cw-sidebar"),X=void 0}}function Ye(e){var t=$(a.createElement("div")).addClass("cw-flipview-content"+(e?" cw-height":"")).hide().mousedown(function(e){e.preventDefault()});return t}function Ze(e,t){var n=$(a.createElement("div")).addClass("cw-close-file cw-height").mousedown(function(e){e.preventDefault()}).attr("title",o.CMD_FILE_CLOSE).click(function(n){De(e,t),n.stopPropagation()}).html("&times;");return n}function Qe(e){var t=$(a.createElement("div")).addClass("cw-trash-file cw-icon-trash").attr("title",o.DELETE).click(function(t){c.deleteItem(e),t.stopPropagation()});return t}function et(e,t){var n=$(a.createElement("div")).addClass("cw-file-actions").append(Qe(e,t)).append(Ze(e,t));return n}function tt(e,t,n,i){var a=u.setLayoutScheme(e,t);a&&window.setTimeout(function(){Oe(n,i,L)},1)}function nt(e,t,n,i,s,c){if(!(t&&(i.addClass("cw-li-bg"),i.outerWidth()<=47))&&(i.addClass("cw-btns"),!t||n)){var l=u.getPaneCount(),f={"first-pane":[o.BOTTOM,o.RIGHT],"second-pane":[o.TOP,o.LEFT]},d=o.FLIPVIEW_BTN_TOOLTIP||"Flip this view to {0} pane";if(2>l){s.removeAttr("title"),s.removeClass("cw-icon-cw "+V[e].join(" "));var w=$(a.createElement("div")).addClass("cw-icon-cw cw-flipview-btn "+V[e][1]).attr("title",r.format(d,f[e][1])).on("click",function(t){tt(1,2,c,e),t.stopPropagation()}),g=$(a.createElement("div")).addClass("cw-icon-cw cw-flipview-btn "+V[e][0]).attr("title",r.format(d,f[e][0])).on("click",function(t){tt(2,1,c,e),t.stopPropagation()});s.append(w),s.append(g)}else{s.removeClass(V[e].join(" "));var h=u.getLayoutScheme();s.addClass("cw-icon-cw "+V[e][h.columns-1]).attr("title",r.format(f[e][h.columns-1])).on("click",function(t){Oe(c,e),t.stopPropagation()})}s.show()}}function it(e,t,n,i,o,r){var s=t.data(x),c=t.attr("class")||"",l="cw-dragged-index,"+(c?c+",":"")+"cw-dragli-"+s.id,f=Ye(i),d=$(a.createElement("li")).mousedown(function(t){t.stopPropagation(),U=!0,2===t.which&&(t.preventDefault(),De(s,e))}).mouseup(function(){U=!1}).click(function(t){1===t.which&&(t.preventDefault(),_e(t,e,s))}).contextmenu(function(t){t.preventDefault(),3===t.which&&_e(t,e,s,!0)}).on("mouseenter",function(){nt(e,i,r,$(this),f,s)}).on("mouseleave",function(){i||f.hide().empty(),i&&($(this).removeClass("cw-li-bg"),r&&f.hide().empty()),$(this).removeClass("cw-btns"),i&&z&&G&&(de.style.display="none",K=!1,j=0,G=!1)}).on("mousemove",function(t){i&&Xe(t,e,s)}).data(F,n+1).on("dragstart",function(t){we=!1;var i=$(this);be=e,pe=n,ve=s,Ee=i.removeClass("cw-dragged-index").addClass("cw-sortable-dragging"),t.originalEvent.dataTransfer.setData("text/plain",s.fullPath),t.originalEvent.dataTransfer.effectAllowed="move",ye.html(i.html()),u.getPaneCount()>1&&$(".horz-resizer").addClass("cw-zIndex-minus")}).on("dragend",function(){U=!1,we||(we=!0,ke&&Ie&&ge&&Ve(be,Ce,pe,Pe,ve),be=void 0,pe=void 0,ve=void 0,Ce=void 0,Pe=void 0,Me=void 0,Ee=void 0,$e=void 0,ge=!0,u.getPaneCount()>1&&$(".horz-resizer").removeClass("cw-zIndex-minus"))}).attr("draggable",!0).append(t.html());return i?(r&&d.append(f),d.append(Ze(s,e)),l+=",cw-height",d.attr({title:s.name}),o||c.indexOf("selected")>-1&&d.width(49)):(d.append(f),d.append(et(s,e))),d.addClass(l.replace(/,/g," ")),d}function at(e,t,n,i){if(t.hasClass("cw-close-tabmenu")){n.removeClass("cw-close-tabmenu"),n.attr("title","Hide Tab Menu");var a=u.getWorkingSetSize(e),r=2===a?o.FIND_IN_FILES_FILE:o.FIND_IN_FILES_FILES;t.find(".cw-tabmenu-files-length").html(a+" "+r),i.empty(),$("#working-set-list-"+e+" .open-files-container").find("ul > li").each(function(t){i.append(it(e,$(this),t,!1))}),t.removeClass("cw-close-tabmenu")}else n.addClass("cw-close-tabmenu"),n.attr("title","Show Tab Menu"),t.addClass("cw-close-tabmenu")}function ot(e){h.execute(g.FILE_CLOSE_LIST,{fileList:u.getWorkingSet(e)}),k.get("pane.mergePanesWhenLastFileClosed")&&e===L&&u.setLayoutScheme(1,1)}function rt(e,t,n){var i=u._getPane(n);u._getPane(t).removeViews(e),i.addListToViewList(e),s.refresh(!0),window.setTimeout(function(){u.setActivePaneId(n),i.focus()},3)}function st(e){var t=u.getWorkingSet(e),n=e===S?L:S,i=u.getPaneCount(),a=u.getCurrentlyViewedFile(e);if(i>1){var o=u.getCurrentlyViewedFile(n);rt(t,e,n),!o&&a&&h.execute(g.FILE_OPEN,{fullPath:a.fullPath,paneId:n})}else{var r=u.setLayoutScheme(2,1);r&&(rt(t,e,n),a&&h.execute(g.FILE_OPEN,{fullPath:a.fullPath,paneId:n}))}}function ct(e,t,n){$("#"+t).prepend(r.format(e,t)),$("#cw-"+t+"-tabbar").on("contextmenu",Se),$("#cw-"+t+"-nav-ul").on("drop dragover dragenter",Re).on("mousewheel",function(e){if(e.preventDefault(),e=window.event||e,I.get(_)){var t=$(this);if(t.children().length&&t[0].scrollWidth>t.parent().width()){var n=Math.max(-1,Math.min(1,e.wheelDelta||-e.detail)),i=t.data(_),a=0>n?q+i:i-q,o=t[0].scrollWidth-t.parent().width(),r=a>o?o:0>a?0:a;t.data(_,r),t.scrollLeft(t.data(_))}}});var i=$("#cw-"+t+"-tabmenu"),a=$("#cw-"+t+"-tabmenu-ul");$("#cw-"+t+"-listview").click(function(){at(t,i,$(this),a)}),i.on("contextmenu",Se),$("#cw-"+t+"-prefs").on("click",function(e){e.preventDefault(),h.execute("PreferencesforCustomWorkforBrackets")}),$("#cw-"+t+"-open").on("click",function(e){e.preventDefault(),h.execute(g.FILE_OPEN)}),$("#cw-"+t+"-move-list").on("click",function(e){e.preventDefault(),st(t)}),$("#cw-"+t+"-close-all").on("click",function(e){e.preventDefault(),ot(t)}),a.on("drop dragover dragenter",Re),$("#cw-"+t+"-hover-sidebar").mouseenter(function(e){e.preventDefault(),R&&!b.isVisible()&&(y.hasClass("cw-force-display")||(X=y.css("z-index"),y.addClass("cw-force-display"),y.css("z-index",19),E.removeClass("cw-sidebar"))),e.stopPropagation()}),n&&(T=$(".cw-sidebar-btn"),b.isVisible()?T.html("←").attr("title",o.CMD_HIDE_SIDEBAR).addClass("cw-show-sidebar"):T.html("→").attr("title",o.CMD_SHOW_SIDEBAR).removeClass("cw-show-sidebar"),T.click(function(){b.toggle()}))}function lt(e){ct(e,S,!0),J=!0,Y=$("#cw-first-pane-navbar"),Z=$("#cw-first-pane-nav-ul"),Q=$("#cw-first-pane-listview"),ee=$("#cw-first-pane-tabmenu"),te=ee.find(".cw-tabmenu-files-length"),ne=$("#cw-first-pane-tabmenu-ul"),ie=$("#working-set-list-first-pane .open-files-container"),u.on("paneCreate",function(){ct(e,L),ae=!0,oe=$("#cw-second-pane-navbar"),re=$("#cw-second-pane-nav-ul"),se=$("#cw-second-pane-listview"),ce=$("#cw-second-pane-tabmenu"),le=ce.find(".cw-tabmenu-files-length"),fe=$("#cw-second-pane-tabmenu-ul"),ue=$("#working-set-list-second-pane .open-files-container")}),u.on("paneDestroy",function(){ae=!1,oe=void 0,re=void 0,se=void 0,ce=void 0,le=void 0,fe=void 0,ue=void 0}),y.on("panelCollapsed",function(){T.html("→").attr("title",o.CMD_SHOW_SIDEBAR).removeClass("cw-show-sidebar"),R&&!b.isVisible()&&E.addClass("cw-sidebar")}),y.on("panelExpanded",function(){T.html("←").attr("title",o.CMD_HIDE_SIDEBAR).addClass("cw-show-sidebar"),R&&b.isVisible()&&E.removeClass("cw-sidebar")}),y.on("mouseleave",function(){Je()}),E.click(function(){window.setTimeout(function(){Je()},3)})}function ft(e,t,n,i,a,r,s,c){var l=u.getWorkingSetSize(e),f=I.get(_),d=!I.get(W),w=r.hasClass("cw-close-tabmenu");l?(n.empty(),i.addClass("cw-visible"),w||s.empty(),a.find("ul > li").each(function(t){var i=$(this);if(n.append(it(e,i,t,!0,f,d)),!w){s.append(it(e,i,t,!1));var a=1===l?o.FIND_IN_FILES_FILE:o.FIND_IN_FILES_FILES;c.html(l+" "+a)}})):(n.html(o.EMPTY_VIEW_HEADER),i.removeClass("cw-visible"),w||r.addClass("cw-close-tabmenu"))}function ut(){J&&ft(S,Y,Z,Q,ie,ee,ne,te),ae&&ft(L,oe,re,se,ue,ce,fe,le)}function gt(){dt?(dt=!1,ut()):wt||(wt=setTimeout(function(){wt=void 0,ut()},150)),z&&G&&(de.style.display="none",K=!1,j=0,G=!1)}function ht(e){I.get(_)&&window.setTimeout(function(){J&&je(S,e,Y,Z),ae&&je(L,e,oe,re)},1)}function mt(e){function r(){J&&(t=i,i=Math.max(a.getElementById("first-pane").clientHeight-83,0),t!==i&&$("#cw-first-pane-tabmenu-box").css("max-height",i)),ae&&(n=o,o=Math.max(a.getElementById("second-pane").clientHeight-83,0),n!==o&&$("#cw-second-pane-tabmenu-box").css("max-height",o))}u.on("currentFileChange",function(){we&&(gt(),ht())}),u.on("workingSetSort workingSetMove",function(){gt(),ht()}),u.on("workingSetAdd workingSetAddList workingSetRemove workingSetRemoveList workingSetUpdate",gt),$(window).on("useIconsOfCustomWork",gt),d.on("dirtyFlagChange",function(){gt(),ht()}),u.on("paneLayoutChange",function(e,t){"HORIZONTAL"===t?($("#cw-"+S+"-move-list").html(A[0]),$("#cw-"+L+"-move-list").html(A[1])):"VERTICAL"===t?($("#cw-"+S+"-move-list").html(A[2]),$("#cw-"+L+"-move-list").html(A[3])):$("#cw-"+S+"-move-list").html(A[0])});var s,t=0,n=0,i=0,o=0;w.on("workspaceUpdateLayout",function(){var e;s&&clearTimeout(s),s=setTimeout(function(){ht(),r(),s=e},501)}),$("#first-pane").on("panelResizeEnd",r),I.definePreference(H,"boolean",!1,{description:"hidden the box(tabMenu)of the right hand if visible, this happens when the document in focus changes their state"}),I.definePreference(O,"boolean",!1,{description:"displays a bar vertical at the right inside of the first editor; when you mouse over this, the sidebar will show if it is hidden"}).on("change",function(){I.get(O)?(R=!0,b.isVisible()||E.addClass("cw-sidebar")):(R=!1,E.removeClass("cw-sidebar"))}),I.definePreference(D,"number",50,{description:"if previous is true (scroll wheel), this will advance x pixels to the right or left according to the rotation of the mouse wheel"}).on("change",function(){q=I.get(D),"number"!=typeof q&&(q=~~I.get(D)),q||(q=50,Le(D,50))}),I.definePreference(N,"boolean",!1,{description:"shows a tooltip with information about the file"}).on("change",function(){I.get(N)?z||($(a.body).append(e),de=a.getElementById("cw-tabbar-tooltip"),z=!0,de.onmouseover=function(){U||(de.style.display="block")},de.onmouseout=function(){U||(de.style.display="none")}):z&&(de.remove(),de=void 0,z=!1)})}function pt(){var e=u.getActivePaneId(),t=$("#cw-"+e+"-listview"),n=$("#cw-"+e+"-tabmenu"),i=$("#cw-"+e+"-tabmenu-ul");at(e,n,t,i)}function vt(){if(I.get(H)){var e=u.getActivePaneId(),t=$("#cw-"+e+"-tabmenu"),n=$("#cw-"+e+"-listview"),i=t.hasClass("cw-close-tabmenu");i||(t.addClass("cw-close-tabmenu"),n.addClass("cw-close-tabmenu"))}}function bt(e,t,n){t&&t.document.on("change",vt),n&&n.document.off("change",vt)}function Ct(){h.register("custom-work-for-brackets-listview",B,pt),l.addBinding(B,"Ctrl-Shift-V","all"),f.on("activeEditorChange",bt)}var T,q,X,Y,Z,Q,ee,te,ne,ie,oe,re,se,ce,le,fe,ue,de,pe,ve,be,Ce,Pe,Me,Ee,$e,wt,i=window,a=i.document,o=brackets.getModule("strings"),r=brackets.getModule("utils/StringUtils"),s=brackets.getModule("project/WorkingSetView"),c=brackets.getModule("project/ProjectManager"),l=brackets.getModule("command/KeyBindingManager"),f=brackets.getModule("editor/EditorManager"),u=brackets.getModule("view/MainViewManager"),d=brackets.getModule("document/DocumentManager"),w=brackets.getModule("view/WorkspaceManager"),g=brackets.getModule("command/Commands"),h=brackets.getModule("command/CommandManager"),m=brackets.getModule("language/LanguageManager"),p=brackets.getModule("project/FileViewController"),v=brackets.getModule("file/FileUtils"),b=brackets.getModule("project/SidebarView"),C=brackets.getModule("command/Menus"),P=C.getContextMenu(C.ContextMenuIds.WORKING_SET_CONTEXT_MENU),M=C.getContextMenu(C.ContextMenuIds.PROJECT_MENU),k=brackets.getModule("preferences/PreferencesManager"),I=k.getExtensionPrefs("custom.work"),E=$(".content"),y=$("#sidebar"),S="first-pane",L="second-pane",x="file",F="index",_="scrollwheel",D="scrollwheel.step",O="hover.sidebar",W="horizontalBar.noSplitButton",N="tooltip",H="autoHideTheTabmenu",B="customworkKeyIdListView",A=["&dArr;","&uArr;","&rArr;","&lArr;","&hArr;"],V={"all-panes":["cw-flipview-icon-none"],"first-pane":["cw-flipview-icon-bottom","cw-flipview-icon-right"],"second-pane":["cw-flipview-icon-top","cw-flipview-icon-left"]},R=!1,z=!1,j=0,U=!1,G=!1,K=!1,J=!1,ae=!1,we=!0,ge=!0,he=!1,me=!1,ke=!1,Ie=!1,ye=$(a.createElement("li")).addClass("cw-height cw-dragged-index cw-sortable-placeholder"),Te=$(a.createElement("li")).addClass("cw-height cw-li-zero"),dt=!0;n.exports={html:lt,extension:mt,ready:Ct}});